#FIXME
# - valgrind cannot be installed on macos, only on linux
# - rust-code-analysis is not tested on macos, so no static analysis

name: av1-grain-macos

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-test:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v3

      - name: Install Rust stable
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true
          components: rustfmt, clippy

      - name: Run rustfmt
        uses: actions-rs/cargo@v1
        with:
          command: fmt
          args: -- --check --verbose

      - name: Run cargo clippy
        uses: actions-rs/clippy-check@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          args: --all-targets --tests --benches -- -D warnings

      - name: Build
        run: cargo build --verbose --tests --benches

      - name: Run tests
        run: cargo test --verbose

      - name: Generate docs
        run: cargo doc --no-deps

  undefined-behaviour-fuzzy-dynamic-analysis:
    needs: [ build-test ]
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v3

      - name: Cache produced data
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-ci-${{ hashFiles('**/Cargo.toml') }}

      - name: Install Rust nightly and miri
        uses: actions-rs/toolchain@v1
        with:
          toolchain: nightly
          components: miri
          override: true

      # FIXME Use binaries
      - name: Install cargo-fuzz
        run: |
          cargo install cargo-fuzz --force

      - name: Run miri
        env:
          # -Zrandomize-layout makes sure not to rely on the layout of anything
          # that might change
          RUSTFLAGS: -Zrandomize-layout
          # -Zmiri-check-number-validity enables checking of integer and float
          # validity (e.g., they must be initialized and not carry
          # pointer provenance) as part of enforcing validity invariants.
          # -Zmiri-tag-raw-pointers enables a lot of extra UB checks relating
          # to raw pointer aliasing rules.
          # -Zmiri-symbolic-alignment-check makes the alignment check more strict.
          MIRIFLAGS: >
            -Zmiri-check-number-validity -Zmiri-tag-raw-pointers
            -Zmiri-symbolic-alignment-check
        run: cargo miri test

      # FIXME Create a template with a dummy series of fuzzy tests
      - name: Init cargo-fuzz
        run: cargo fuzz init

      - name: Run cargo-fuzz
        run: cargo fuzz build
